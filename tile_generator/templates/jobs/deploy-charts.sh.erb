#!/bin/bash

set -e
set -x

export PATH="/var/vcap/packages/pks_cli:$PATH"
export PATH="/var/vcap/packages/helm_cli/linux-amd64:$PATH"
export PATH="/var/vcap/packages/kubectl_cli:$PATH"

export PKS_HOST=<%= Shellwords.escape(p('pks_host')) %>
export PKS_USERNAME=<%= Shellwords.escape(p('pks_username')) %>
export PKS_PASSWORD=<%= Shellwords.escape(p('pks_password')) %>
export PKS_CLUSTER_NAME=<%= Shellwords.escape(p('pks_cluster')) %>
export BOSH_DEPLOYMENT=<%= spec.deployment %>

# Use PKS to connect kubectl to the named cluster
#
pks login --api "$PKS_HOST" --username "$PKS_USERNAME" --password "$PKS_PASSWORD" --skip-ssl-validation # FIXME --ca-cert /path/to/cert
pks get-credentials "$PKS_CLUSTER_NAME"
sleep 1
# Install Tiller
#
helm init

# Create a service account with the right permissions for tiller to do it's thing with RBAC enabled
#
kubectl create serviceaccount --namespace kube-system tiller || true
kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller || true
kubectl patch deploy --namespace kube-system tiller-deploy -p '{"spec":{"template":{"spec":{"serviceAccount":"tiller"}}}}' || true

# Wait for tiller to become ready
#
echo -n "waiting for tiller"
while ! helm list 2>/dev/null; do
  echo -n .
	sleep 1
done
echo

# Maybe run a docker registry in the cluster to use? https://stackoverflow.com/a/42564191
# Or use Harbor if it's there?
for image in /var/vcap/packages/*-images/*; do
  echo "FIXME: use the packaged image $image"
done

# Unzip any zipped helm charts
#
for zip in /var/vcap/packages/*/*.zip; do
  if unzip -l ${zip} \*/Chart.yaml >/dev/null; then
    (cd $(dirname ${zip}); unzip ${zip})
  fi
done

# Now install all helm charts
#


{% for package in context.packages if package['package-type'] == 'helm' %}

  HELM_NAME={{ package.name }}
  HELM_RELEASE=$(helm list "^${HELM_NAME}\$")
  if [ -z "$HELM_RELEASE" ]; then
    HELM_NAMESPACE={{ package.namespace }}
    if [ -n "$HELM_NAMESPACE" ]; then
      helm install $(dirname /var/vcap/packages/$HELM_NAME/*/Chart.yaml) --namespace "${HELM_NAMESPACE}"
    else
      helm install $(dirname /var/vcap/packages/$HELM_NAME/*/Chart.yaml)
    fi
  else
    echo "${HELM_NAME} is already deployed"
  fi

{% endfor %}
